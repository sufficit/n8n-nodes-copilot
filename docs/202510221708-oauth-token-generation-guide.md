# GitHub Copilot OAuth Token Generation - Complete Guide

**Version**: 202510221708  
**Status**: âœ… WORKING  
**Last Updated**: October 22, 2025

## Overview

This document explains the **EXACT process** that VS Code uses to generate GitHub Copilot OAuth tokens (the `tid=...` format). This was discovered through reverse engineering VS Code's authentication flow.

---

## ğŸ”‘ Token Types

### 1. GitHub Token (gho_*)
- **Format**: `gho_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX` (40 characters)
- **Source**: GitHub OAuth device flow
- **Duration**: Permanent (doesn't expire automatically)
- **Purpose**: Authenticate with GitHub APIs
- **Generated by**: `scripts/authenticate.js`

### 2. OAuth Token (tid=...)
- **Format**: `tid=xxx;exp=xxx;sku=xxx;...` (300+ characters)
- **Source**: GitHub Copilot internal API endpoint
- **Duration**: ~20 minutes (1200 seconds)
- **Purpose**: Authenticate with GitHub Copilot services
- **Generated by**: `scripts/generate-oauth-token.js` (NEW!)

---

## ğŸ” OAuth Token Generation Flow

### Step 1: Prerequisites

You need a **GitHub token** (gho_*) first. Get it by running:
```bash
node scripts/authenticate.js
```

This will save the token to `./.token` file.

### Step 2: Generate Machine ID

VS Code generates a persistent **machine identifier** (SHA-256 hash):

```javascript
const crypto = require('crypto');

// Generate once and save
const randomData = crypto.randomBytes(32);
const machineId = crypto.createHash('sha256').update(randomData).digest('hex');

// Example: 579823533754bc72e0b580f142347d81f4383173ee0c7a71a428641ed6e76d8a
```

**Purpose**: Identifies the same machine across sessions  
**Storage**: Saved in `./.machine-id` file  
**Reuse**: Same machine ID used for all future token generations

### Step 3: Generate Session ID

VS Code generates a **session identifier** (UUID + timestamp):

```javascript
const crypto = require('crypto');

const uuid = crypto.randomUUID();
const timestamp = Date.now();
const sessionId = `${uuid}${timestamp}`;

// Example: b63c867a-d706-46ad-a9b1-f2f2e5e9f0661761152935126
```

**Purpose**: Identifies unique VS Code session  
**Lifetime**: Regenerated on each VS Code restart  
**Format**: UUID (36 chars) + Unix timestamp (13 chars) = 49 characters

### Step 4: Request OAuth Token

**Endpoint**: `GET https://api.github.com/copilot_internal/v2/token`

**Required Headers**:
```javascript
{
    'Authorization': `token ${githubToken}`,           // GitHub token (gho_*)
    'Accept': 'application/json',
    'User-Agent': 'GitHubCopilotChat/0.32.3',
    'Editor-Version': 'vscode/1.105.1',                // VS Code version
    'Editor-Plugin-Version': 'copilot-chat/0.32.3',    // Copilot extension version
    'Vscode-Machineid': machineId,                     // Machine identifier
    'Vscode-Sessionid': sessionId,                     // Session identifier
    'X-GitHub-Api-Version': '2025-08-20'               // API version
}
```

**Important Notes**:
- âœ… Method is **GET** (no request body)
- âœ… All headers are **required** for successful authentication
- âœ… `Vscode-Machineid` must be consistent per machine
- âœ… `Vscode-Sessionid` should be unique per session

### Step 5: Response

**Success (200 OK)**:
```json
{
  "token": "tid=xxx;exp=xxx;sku=xxx;...",
  "expires_at": 1761154735,
  "refresh_in": 1500,
  "sku": "plus_monthly_subscriber_quota",
  "chat_enabled": true,
  "endpoints": {
    "api": "https://api.individual.githubcopilot.com",
    "proxy": "https://proxy.individual.githubcopilot.com",
    "telemetry": "https://telemetry.individual.githubcopilot.com"
  },
  "individual": true,
  "prompt_8k": true,
  "chat_jetbrains_enabled": true,
  "code_quote_enabled": true,
  "annotations_enabled": true,
  "code_review_enabled": true,
  "codesearch": true
}
```

**Error Responses**:
- **401 Unauthorized**: Invalid GitHub token
- **403 Forbidden**: No Copilot subscription
- **404 Not Found**: Wrong endpoint or API version

---

## ğŸ“‹ Response Fields Explained

| Field | Type | Description |
|-------|------|-------------|
| **token** | string | OAuth token with all parameters (tid=...) |
| **expires_at** | number | Unix timestamp when token expires |
| **refresh_in** | number | Seconds until token should be refreshed (1500 = 25 min) |
| **sku** | string | Subscription type (e.g., `plus_monthly_subscriber_quota`) |
| **chat_enabled** | boolean | Whether Copilot Chat is available |
| **endpoints** | object | API endpoints for different services |
| **individual** | boolean | Whether this is an individual subscription |
| **prompt_8k** | boolean | Whether 8K token context is supported |
| **limited_user_quotas** | object/null | Usage quotas (null for unlimited) |

### Endpoints Object

```json
{
  "api": "https://api.individual.githubcopilot.com",
  "origin-tracker": "https://origin-tracker.individual.githubcopilot.com",
  "proxy": "https://proxy.individual.githubcopilot.com",
  "telemetry": "https://telemetry.individual.githubcopilot.com"
}
```

**Note**: These endpoints are returned by the API but the standard `api.githubcopilot.com` endpoint still works for all operations.

---

## ğŸ” OAuth Token Structure

The generated token has this format:
```
tid=xxx;exp=xxx;sku=xxx;proxy-ep=xxx;st=xxx;chat=1;cit=1;malfil=1;...;asn=xxx:xxx
```

**All Parameters**:
```javascript
{
  "tid": "07a8362f96297dd0915704bb34ecd317",              // Token ID (32 hex chars)
  "exp": "1761154735",                                    // Expiration (Unix timestamp)
  "sku": "plus_monthly_subscriber_quota",                 // Subscription type
  "proxy-ep": "proxy.individual.githubcopilot.com",       // Proxy endpoint
  "st": "dotcom",                                         // Service type (dotcom/enterprise)
  "chat": "1",                                            // Chat enabled
  "cit": "1",                                             // Code intelligence
  "malfil": "1",                                          // Malware filter
  "editor_preview_features": "1",                         // Preview features
  "agent_mode": "1",                                      // Agent mode
  "mcp": "1",                                             // Model Context Protocol
  "ccr": "1",                                             // Code completion rights
  "8kp": "1",                                             // 8K token support
  "ip": "177.36.188.73",                                  // Client IP address
  "asn": "AS53062:a949a06018fc4d153a32e51f4a4f776b..."   // ASN + HMAC signature
}
```

**HMAC Signature (asn parameter)**:
- Format: `ASN_NUMBER:HMAC_SHA256_HASH`
- The hash validates all other parameters
- Cannot be forged without GitHub's secret key
- Prevents token tampering

---

## ğŸš€ Usage

### Automatic Token Generation

```bash
# Generate OAuth token
node scripts/generate-oauth-token.js
```

**Output Files**:
- `.token.oauth` - OAuth token (ready to use)
- `.token.oauth.generated.json` - Full generation details
- `.machine-id` - Persistent machine identifier

### Manual Token Generation

```javascript
const https = require('https');
const crypto = require('crypto');

// 1. Load GitHub token
const githubToken = 'gho_XXXXXXXXXXXXXXXXXXXX';

// 2. Generate identifiers
const machineId = crypto.createHash('sha256')
    .update(crypto.randomBytes(32))
    .digest('hex');

const sessionId = `${crypto.randomUUID()}${Date.now()}`;

// 3. Request OAuth token
const options = {
    hostname: 'api.github.com',
    path: '/copilot_internal/v2/token',
    method: 'GET',
    headers: {
        'Authorization': `token ${githubToken}`,
        'Accept': 'application/json',
        'User-Agent': 'GitHubCopilotChat/0.32.3',
        'Editor-Version': 'vscode/1.105.1',
        'Editor-Plugin-Version': 'copilot-chat/0.32.3',
        'Vscode-Machineid': machineId,
        'Vscode-Sessionid': sessionId,
        'X-GitHub-Api-Version': '2025-08-20'
    }
};

https.get(options, (res) => {
    let data = '';
    res.on('data', (chunk) => data += chunk);
    res.on('end', () => {
        const response = JSON.parse(data);
        console.log('OAuth Token:', response.token);
    });
});
```

### Using the Token

```javascript
const fs = require('fs');
const https = require('https');

// Load token
const token = fs.readFileSync('./.token.oauth', 'utf8').trim();

// Use in requests
const options = {
    hostname: 'api.githubcopilot.com',
    path: '/chat/completions',
    method: 'POST',
    headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
        'Editor-Version': 'vscode/1.105.1',
        'X-GitHub-Api-Version': '2025-08-20'
    }
};
```

---

## â° Token Lifecycle

### Generation
1. Client requests token with GitHub token + machine/session IDs
2. GitHub validates credentials and subscription
3. Server generates token with HMAC signature
4. Client receives token + metadata

### Usage
1. Client includes token in `Authorization: Bearer` header
2. Server validates HMAC signature
3. Server checks expiration
4. Request processed if valid

### Refresh
1. Check `expires_at` timestamp
2. When < 5 minutes remaining, refresh
3. Make new request to `/copilot_internal/v2/token`
4. Receive new token with extended expiration

**Recommendation**: Refresh token every 15 minutes (when `refresh_in` value is reached)

---

## ğŸ”’ Security Considerations

### Token Protection
- âœ… **Never commit tokens** to version control
- âœ… **Store in .gitignore'd files** (.token.oauth)
- âœ… **Rotate regularly** (every 20 minutes automatically)
- âœ… **Don't log complete tokens** (only first 20 chars)

### HMAC Validation
- âœ… **Cannot modify parameters** without breaking signature
- âœ… **IP address validated** by server
- âœ… **Expiration enforced** server-side
- âœ… **Subscription checked** on each request

### Best Practices
```javascript
// âœ… Good - Load from file
const token = fs.readFileSync('./.token.oauth', 'utf8').trim();

// âŒ Bad - Hardcode in code
const token = 'tid=xxx;exp=xxx;...';

// âœ… Good - Check expiration
const expMatch = token.match(/exp=(\d+)/);
const expiresAt = parseInt(expMatch[1]) * 1000;
if (Date.now() >= expiresAt) {
    // Refresh token
}

// âœ… Good - Secure logging
console.log(`Token: ${token.substring(0, 20)}...`);
```

---

## ğŸ§ª Testing

### Test Token Generation
```bash
node scripts/generate-oauth-token.js
```

### Test Token Validity
```bash
node temp/quick-test-token.js
```

### Test All Endpoints
```bash
node temp/test-oauth-on-chat.js
```

**Expected Results**:
- âœ… Chat Completions: 200 OK
- âœ… Embeddings: 200 OK
- âœ… Models List: 200 OK

---

## ğŸ“Š Complete Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. GitHub OAuth Device Flow                                     â”‚
â”‚    â†’ Get GitHub token (gho_*)                                   â”‚
â”‚    â†’ Save to .token                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Generate Identifiers                                         â”‚
â”‚    â†’ Machine ID (SHA-256, persistent)                           â”‚
â”‚    â†’ Session ID (UUID + timestamp)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Request OAuth Token                                          â”‚
â”‚    GET /copilot_internal/v2/token                               â”‚
â”‚    Headers:                                                     â”‚
â”‚      - Authorization: token gho_*                               â”‚
â”‚      - Vscode-Machineid: xxx                                    â”‚
â”‚      - Vscode-Sessionid: xxx                                    â”‚
â”‚      - Editor-Version: vscode/1.105.1                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Receive Response                                             â”‚
â”‚    {                                                            â”‚
â”‚      "token": "tid=xxx;exp=xxx;...",                            â”‚
â”‚      "expires_at": 1761154735,                                  â”‚
â”‚      "refresh_in": 1500,                                        â”‚
â”‚      "endpoints": {...}                                         â”‚
â”‚    }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Use OAuth Token                                              â”‚
â”‚    â†’ Chat Completions (/chat/completions)                       â”‚
â”‚    â†’ Embeddings (/embeddings)                                   â”‚
â”‚    â†’ Models List (/models)                                      â”‚
â”‚    Authorization: Bearer tid=xxx;exp=xxx;...                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Implementation for n8n

### Credentials File

```typescript
export class GitHubCopilotApi implements ICredentialType {
    name = 'gitHubCopilotApi';
    displayName = 'GitHub Copilot API';
    
    properties: INodeProperties[] = [
        {
            displayName: 'Authentication Method',
            name: 'authMethod',
            type: 'options',
            options: [
                {
                    name: 'GitHub Token',
                    value: 'github',
                    description: 'Use GitHub personal access token (gho_*)'
                },
                {
                    name: 'OAuth Token',
                    value: 'oauth',
                    description: 'Use pre-generated OAuth token (tid=...)'
                }
            ],
            default: 'github'
        },
        {
            displayName: 'GitHub Token',
            name: 'githubToken',
            type: 'string',
            typeOptions: { password: true },
            displayOptions: {
                show: { authMethod: ['github'] }
            },
            default: '',
            description: 'GitHub personal access token (gho_*)'
        },
        {
            displayName: 'OAuth Token',
            name: 'oauthToken',
            type: 'string',
            typeOptions: { password: true },
            displayOptions: {
                show: { authMethod: ['oauth'] }
            },
            default: '',
            description: 'Pre-generated OAuth token (tid=...)'
        },
        {
            displayName: 'Machine ID',
            name: 'machineId',
            type: 'string',
            displayOptions: {
                show: { authMethod: ['github'] }
            },
            default: '',
            description: 'Optional: VS Code machine identifier (auto-generated if empty)'
        }
    ];
}
```

### Node Logic

```typescript
async getOAuthToken(credentials: ICredentials): Promise<string> {
    // If OAuth token provided, use it directly
    if (credentials.authMethod === 'oauth') {
        return credentials.oauthToken as string;
    }
    
    // Generate OAuth token from GitHub token
    const githubToken = credentials.githubToken as string;
    const machineId = credentials.machineId || this.generateMachineId();
    const sessionId = this.generateSessionId();
    
    const response = await this.makeRequest({
        method: 'GET',
        url: 'https://api.github.com/copilot_internal/v2/token',
        headers: {
            'Authorization': `token ${githubToken}`,
            'Vscode-Machineid': machineId,
            'Vscode-Sessionid': sessionId,
            'Editor-Version': 'vscode/1.105.1',
            'Editor-Plugin-Version': 'copilot-chat/0.32.3',
            'X-GitHub-Api-Version': '2025-08-20'
        }
    });
    
    return response.token;
}
```

---

## ğŸ“ Summary

### What We Discovered

1. âœ… **OAuth Token Generation Endpoint**: `GET /copilot_internal/v2/token`
2. âœ… **Required Headers**: Authorization, Machine ID, Session ID, Editor versions
3. âœ… **Token Format**: Semicolon-separated parameters with HMAC signature
4. âœ… **Token Lifetime**: ~20 minutes (expires_at timestamp)
5. âœ… **Token Usage**: Works on ALL Copilot endpoints

### Scripts Created

1. **`scripts/authenticate.js`** - Get GitHub token (gho_*)
2. **`scripts/generate-oauth-token.js`** - Generate OAuth token (tid=...) â­ **NEW**
3. **`scripts/extract-oauth-token.js`** - Extract token from VS Code cache
4. **`temp/quick-test-token.js`** - Test embeddings endpoint
5. **`temp/test-oauth-on-chat.js`** - Test all endpoints

### Files Generated

1. **`.token`** - GitHub token (permanent)
2. **`.token.oauth`** - OAuth token (20 min)
3. **`.token.oauth.generated.json`** - Generation details
4. **`.machine-id`** - Persistent machine identifier

---

**Document Status**: âœ… Complete  
**Last Tested**: October 22, 2025  
**Token Generation**: âœ… Working  
**All Endpoints**: âœ… Tested
